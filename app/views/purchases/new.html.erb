<div class="container sign_up purc_ready">
  <div class="row">
    <div class="col-md-12 mb_line_break_reverse">
      <h3 class="header header_sub">주문 / 결제</h3>
    </div>
    <div class="col-md-12">
      <div class="col-md-12">
        <h3 class="header">주문 상품 확인</h3>
      </div>
      <div class="col-md-12">
        <!-- desktop -->
        <div class="mb_line_break_reverse">
          <table class="table table-hover tb_purc">
            <thead>
              <tr> <th>&nbsp;</th> <th class="tb_purc_name">상품명</th> <th class="tb_purc_shipping">배송비</th> <th class="tb_purc_price">상품 가격</th> </tr>
            </thead>
            <tbody>
              <% @purchase_list.purchase_items.each do |item| %>
              <tr>
                <th class="tb_purc_image" scope="row"> <%= image_tag(item.product.image_basic, style: "width:100px;height:100px;") %> </th>
                <td class="tb_purc_name"><h5><%= item.product.name %></h5><p>옵션 : <%= item.option %></p></td>
                <td class="tb_purc_shipping"><%= item.product.shipping_expenses %> 원</td>
                <td class="tb_purc_price"><%= item.product.price %> 원</td>
              </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <!-- desktop -->

        <!-- mb -->
        <div class="mb_line_break">
          <table class="table table-striped table-hover">
            <thead>
              <tr> <th>&nbsp;</th> <th>&nbsp;</th> </tr>
            </thead>
            <tbody>
              <% @purchase_list.purchase_items.each do |item| %>
              <tr> <th scope="row"> <%= image_tag item.product.image_basic, style: "width:75px;height:75px;" %> </th> <td><h5><%= item.product.name %></h5><p class="help-block">옵션 : <%= item.option %><br> <%= item.product.price %> 원&nbsp;&nbsp;<%= item.product.shipping_expenses %> 원</p></td> </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <!-- mb -->
      </div><!-- col-md-12 -->

      <div class="col-md-7 no-gap">
        <div class="col-md-12" style="padding: 0px 15px; margin-bottom: 10px;">
          <h3 class="header">배송 정보</h3>
        </div>
        <div class="col-md-12">
          <div class="col-md-12">
            <%= render "shared/address_book" %>
          </div>
        </div><!-- 배송 정보 -->

        <div class="col-md-12 mb_line_break_reverse">
          <h3 class="header">결제 정보</h3>
        </div>
        <div class="col-md-12 pay_method" style="padding-left:15px;padding-right:15px;">
          <p>*결제 수단</p>
          <div class="pay_method_box pay_method_card pay_method_selected">
            <p>신용 카드</p>
          </div>

          <div class="pay_method_box pay_method_vbank">
            <p>무통장 입금</p>
          </div>

          <div class="pay_method_box pay_method_trans">
            <p>계좌 이체</p>
          </div>

          <div class="pay_method_box pay_method_phone">
            <p>휴대폰 결제</p>
          </div>
        </div>
      </div><!-- col-md-7 -->

      <div class="col-md-5">
        <div class="col-md-12 pay_info">
          <h3 class="header header_main">결제 금액 정보</h3>
          <p class="header_sub">총 상품 금액 <span><%= total_price = @purchase_list.purchase_items.inject(0){ |sum, item| sum += item.product.price } %> 원</span></p>
          <p class="header_sub">배송비 <span><%= total_shipping_expenses = @purchase_list.purchase_items.inject(0){ |sum, item| sum += item.product.shipping_expenses } %> 원</span></p>
          <p class="header_sub">할인 <span>-<%= total_discount = @purchase_list.purchase_items.inject(0){ |sum, item| sum += item.product.discount } %> 원</span></p>
          <hr>
          <p class="header_sub">최종결제금액 <span><%= total_price + total_shipping_expenses - total_discount %> 원</span></p>
        </div>

        <div class="col-md-12 pay_info">
          <div class="col-md-12 no-gap">
            <div class="checkbox">
              <input type="checkbox" id="agreementCheckbox" class="checkbox-style"/>
              <label for="agreementCheckbox"><a href="#">구매조건</a> 확인 및 결제진행에 동의합니다. </label>
            </div>
            <p class="help-block" style="font-size:10px;">구매하신 상품 배송 및 주문처리를 위해 개인정보를 제공받는 판매자 : Vivant, <b>Todo 판매자들 모두 나오도록변경</b></p>
          </div>
        </div>
        <div class="col-md-12 text-center pay_go">
          <%= button_tag "결제 진행", class: "btn session_btn_black", id: "buyBtn" %>
          <%= hidden_field_tag "purchase_list_name", "#{@purchase_list.purchase_items.first.product.name}" + (@purchase_list.purchase_items.size > 1 ? " 외 #{@purchase_list.purchase_items.size} 개 " : "") + "구매" %>
          <%= hidden_field_tag "total_purchase_price", total_price + total_shipping_expenses - total_discount  %>
          <%= hidden_field_tag "pay_method", "card" %>
        </div>
      </div><!-- col-md-5 -->
    </div><!-- col-md-12 -->
  </div><!-- .row -->
</div>

<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.1.js"></script>
<script type="text/javascript">
  $(document).on('click', '#buyBtn', function() {
    if ($('#agreementCheckbox').prop('checked')) {
      var IMP = window.IMP;
      IMP.init('<%= Rails.application.secrets.iamport_user_code %>');

      IMP.request_pay({
        pg : 'html5_inicis',
        pay_method : $('#pay_method').val(),
        merchant_uid : '<%= @purchase_list.id %>',
        name : $('#purchase_list_name').val(),
        amount : $('#total_purchase_price').val(),
        buyer_email : '<%= current_user.email %>',
        buyer_name : '<%= current_user.name %>',
        buyer_tel : $('#phone_number1').val() + '-' + $('#phone_number2').val() + '-' + $('#phone_number3').val(),
        buyer_addr : $('#address').val() + ' ' + $('#address_detail').val(),
        buyer_postcode : $('#zonecode').val(),
        m_redirect_url: 'trd.st'
      }, function(rsp) {
        if ( rsp.success ) {
          rsp["demand_message"] = $('#demand_message').val();
          rsp["receiver"] = $('#receiver').val();
          rsp["address"] = $('#address').val();
          rsp["address_detail"] = $('#address_detail').val();
          rsp["zonecode"] = $('#zonecode').val();
          rsp["phone_number"] = $('#phone_number1').val() + '-' + $('#phone_number2').val() + '-' + $('#phone_number3').val();

          $.ajax({
            url: '/purchases',
            method: 'post',
            data: rsp
          }).done(function(res) {
            location.href = '/purchases/complete?purchase_list_id=<%= @purchase_list.id %>';
          }).fail(function(res){
            console.log(res);
            alert('결제 처리에 실패하였습니다. ');
          });
        } else {
          var msg = '결제에 실패하였습니다.';
          msg += '에러내용 : ' + rsp.error_msg;

          alert(msg);
        }
      });
    } else {
      alert('구매조건 확인 및 결제진행에 동의하셔야 합니다');
      $('#agreementCheckbox').next().addClass('notchecked');
    }
  });
</script>

<script type="text/javascript">
  $(document).on('click', '#agreementCheckbox', function() {
    $(this).next().removeClass('notchecked');
  });

  $(document).on('click', '.pay_method_box', function() {
    var payMethod = 'card';

    if ($(this).hasClass('pay_method_card')) {
      payMethod = 'card';
    } else if ($(this).hasClass('pay_method_vbank')) {
      payMethod = 'vbank';
    } else if ($(this).hasClass('pay_method_trans')) {
      payMethod = 'trans';
    } else if ($(this).hasClass('pay_method_phone')) {
      payMethod = 'phone';
    }

    $('#pay_method').val(payMethod);

    $('.pay_method_box').removeClass('pay_method_selected');
    $(this).addClass('pay_method_selected');
  });
</script>
